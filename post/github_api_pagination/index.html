<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.55.6" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="damao" />
  <meta property="og:url" content="https://simpleowen.github.io/post/github_api_pagination/" />
  <link rel="canonical" href="https://simpleowen.github.io/post/github_api_pagination/" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/simpleowen.github.io\/"
      },
      "articleSection" : "post",
      "name" : "Golang 获取 Github API 分页总页数",
      "headline" : "Golang 获取 Github API 分页总页数",
      "description" : "Github API 会自动对所请求的项目进行分页 不同的 API 会有不同的每页数目，有的 API 默认每页 100 项，有的 API 默认每页 30 项，可以通过 per_page=xxx 参数改变每页展示项目数，但最大",
      "inLanguage" : "en-US",
      "author" : "damao",
      "creator" : "damao",
      "publisher": "damao",
      "accountablePerson" : "damao",
      "copyrightHolder" : "damao",
      "copyrightYear" : "2019",
      "datePublished": "2019-05-29 12:15:13 -0400 EDT",
      "dateModified" : "2019-05-29 12:15:13 -0400 EDT",
      "url" : "https:\/\/simpleowen.github.io\/post\/github_api_pagination\/",
      "keywords" : [ "github api","分页", ]
  }
</script>
<title>Golang 获取 Github API 分页总页数 - 我坦白~</title>
  <meta property="og:title" content="Golang 获取 Github API 分页总页数 - 我坦白~" />
  <meta property="og:type" content="article" />
  <meta name="description" content="Github API 会自动对所请求的项目进行分页 不同的 API 会有不同的每页数目，有的 API 默认每页 100 项，有的 API 默认每页 30 项，可以通过 per_page=xxx 参数改变每页展示项目数，但最大" />

  <link rel="stylesheet" href="https://unpkg.com/flexboxgrid@6.3.1/dist/flexboxgrid.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="我坦白~">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  <script>
    

    (function (undefined) { }).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  
</head>

<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">damao</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Golang 获取 Github API 分页总页数</h1>
          <div class="row">
            <div class="col-xs-6">
              <time class="post-date" datetime="2019-05-29 12:15:13 EDT">
                29, May, 2019
              </time>
            </div>
            <div class="col-xs-6">
              <div class="post-author">
                <a target="_blank" href="">@damao</a>
              </div>
            </div>
          </div>
        </header>

        <div class="post-content markdown-body">
          

<p>Github API 会自动对所请求的项目进行分页</p>

<p>不同的 API 会有不同的每页数目，有的 API 默认每页 100 项，有的 API 默认每页 30 项，可以通过 per_page=xxx 参数改变每页展示项目数，但最大值为 100。但是也有例外，比如，<a href="https://developer.github.com/v3/activity/events/">Events</a> 就不会让你设置最大每页数</p>

<p>调用 Github API 时会返回在一个响应头 <code>Link header</code>， 开发者可通过解析 <code>Link header</code> 来获取分页信息</p>

<h2 id="link-header-样式">Link header 样式</h2>

<p>默认请求，github api 返回的 Link header 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">Link: &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=2&gt;; rel=&#34;next&#34;,
  &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=34&gt;; rel=&#34;last&#34;</pre></td></tr></table>
</div>
</div>
<p>请求传入 page=xxx 参数，返回的 Link header 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">Link: &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=15&gt;; rel=&#34;next&#34;,
  &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=34&gt;; rel=&#34;last&#34;,
  &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=1&gt;; rel=&#34;first&#34;,
  &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=13&gt;; rel=&#34;prev&#34;</pre></td></tr></table>
</div>
</div>
<h2 id="解析-link-header-总页数">解析 Link Header 总页数</h2>

<ul>
<li>方案一

<ul>
<li>分解字符串</li>
<li>以 <code>逗号</code> 为分隔符，分解出每条 link</li>
<li>以 <code>分号</code> 为分割符，分解带 <code>rel=&quot;last&quot;</code> 的链接为链接部分和链接类型部分</li>
<li>以 <code>page=</code> 为分割符，分解出链接前部和 <code>页数&gt;</code> 部分</li>
<li>去除 <code>&gt;</code> 后得总页数</li>
</ul></li>
<li>方案二

<ul>
<li>正则匹配</li>
<li>设置正则表达式 <code>page=(\d+)&gt;; rel=&quot;last&quot;</code></li>
<li>匹配整个 Link header 字符串</li>
<li>找出总页数</li>
</ul></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">    <span class="kn">package</span> <span class="nx">main</span>

    <span class="kn">import</span> <span class="p">(</span>
        <span class="s">&#34;fmt&#34;</span>
        <span class="s">&#34;log&#34;</span>
        <span class="s">&#34;regexp&#34;</span>
        <span class="s">&#34;strconv&#34;</span>
        <span class="s">&#34;strings&#34;</span>
    <span class="p">)</span>

    <span class="kd">var</span> <span class="nx">linkHeader</span> <span class="p">=</span> <span class="s">`&lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=15&gt;; rel=&#34;next&#34;,
</span><span class="s">                &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=34&gt;; rel=&#34;last&#34;,
</span><span class="s">                &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=1&gt;; rel=&#34;first&#34;,
</span><span class="s">                &lt;https://api.github.com/search/code?q=addClass+user%3Amozilla&amp;page=13&gt;; rel=&#34;prev&#34;`</span>

    <span class="kd">func</span> <span class="nf">split</span><span class="p">(</span><span class="nx">linkHeader</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">link</span> <span class="kt">string</span>
        <span class="nx">links</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">links</span> <span class="p">{</span>
            <span class="nx">v</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="s">`rel=&#34;last&#34;`</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">link</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="s">&#34;;&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// fmt.Println(link)
</span><span class="c1"></span>        <span class="nx">totalPageNum</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSuffix</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">link</span><span class="p">,</span> <span class="s">&#34;page=&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;&gt;&#34;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">totalPageNum</span><span class="p">,</span> <span class="kc">nil</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">regex</span><span class="p">(</span><span class="nx">linkHeader</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">rege</span> <span class="o">:=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">`page=(\d+)&gt;; rel=&#34;last&#34;`</span><span class="p">)</span>
        <span class="c1">// fmt.Println(rege.MatchString(linkHeader))
</span><span class="c1"></span>        <span class="nx">totalPages</span> <span class="o">:=</span> <span class="nx">rege</span><span class="p">.</span><span class="nf">FindStringSubmatch</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="nx">totalPageNum</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">totalPages</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="c1">// fmt.Println(totalPageNum)
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">totalPageNum</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//方案一
</span><span class="c1"></span>        <span class="nx">numberOfPages</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">regex</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">numberOfPages</span><span class="p">)</span>

    <span class="c1">//方案二
</span><span class="c1"></span>        <span class="nx">numberOfPages</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">split</span><span class="p">(</span><span class="nx">linkHeader</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">numberOfPages</span><span class="p">)</span>
    <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="refs">Refs</h2>

<ul>
<li><a href="https://developer.github.com/v3/guides/traversing-with-pagination/">Traversing with Pagination | GitHub Developer Guide</a></li>
<li><a href="https://github.com/github/platform-samples/tree/master/api/ruby/traversing-with-pagination">platform-samples/api/ruby/traversing-with-pagination at master · github/platform-samples</a></li>
<li><a href="https://tools.ietf.org/html/rfc5988#section-5">RFC 5988 - Web Linking</a></li>
<li><a href="https://en.wikipedia.org/wiki/Regular_expression">Regular expression - Wikipedia</a></li>
<li><a href="https://www.cnblogs.com/ghj1976/archive/2013/03/21/2972522.html">Go语言正则表达式提取网页文本 - 蝈蝈俊 - 博客园</a></li>
</ul>

        </div>
        
        
        
        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="https://github.com/joway/hugo-theme-yinyang" target="_blank">Theme</a>
  </div>
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>
<script src="https://unpkg.com/quicklink@0.1.1/dist/quicklink.umd.js"></script>

<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

  

</body>

</html>